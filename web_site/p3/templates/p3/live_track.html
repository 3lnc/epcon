<html>
<head>
    <style>
    @font-face {
        font-family: 'League Gothic';
        src: url('{{ STATIC_URL }}p5/f/League_Gothic.eot');
        src: url('{{ STATIC_URL }}p5/f/League_Gothic.eot?iefix') format('eot'),
            url('{{ STATIC_URL }}p5/f/League_Gothic.woff') format('woff'),
            url('{{ STATIC_URL }}p5/f/League_Gothic.ttf') format('truetype'),
            url('{{ STATIC_URL }}p5/f/League_Gothic.svg#webfont1Lb5Pdit') format('svg');
        font-weight: normal;
        font-style: normal;
    }
    body {
        background: #fcfad9 url({{ STATIC_URL }}p5/i/body.png) top left repeat fixed;
        color: #301d1d;
    }
    #countdown {
        font: normal 600px/600px "League Gothic", Verdana, sans-serif;
        text-align: center;
    }
    #next {
        font: normal 40px/40px "League Gothic", Verdana, sans-serif;
    }
    #now {
        text-align: center;
        font: normal 80px/80px "League Gothic", Verdana, sans-serif;
    }
    #load-feedback {
        position: absolute;
        width: 32px;
        height: 32px;
        background: #006600;
        display: none;
    }
    </style>
    <script type="text/javascript" src="{{ STATIC_URL }}conference/jquery-ui/js/jquery-1.7.1.min.js"></script>
</head>
<body>
    <div id="load-feedback"></div>
    <div id="now"></div>
    <div id="countdown">--</div>
    <div id="next"></div>
</body>
<script>
    var events = null;
    function load() {
        $.getJSON('./events', function(data, textStatus, xhr) {
            var parsed = []
            for(var ix=0, ex=data.length; ix<ex; ix++) {
                var e = data[ix];
                var _ = e['time'].split(' ');
                var date = _[0].split('/');
                var time = _[1].split(':');
                var d = new Date(date[2], date[1], date[0], time[0], time[1], time[2]);
                e['time'] = d;
                parsed.push(e)
            }
            events = parsed;

            var f = $('#load-feedback');
            f.show();
            setTimeout(function() { f.hide(); }, 3000);

            update();
        });
    }
    load();
    setInterval(load, 60 * 1000);
    function update() {
        if(!events) {
            return;
        }
        var now = new Date();
        var evt = null;
        var next = null;
        for(var ix=0, ex=events.length; ix<ex; ix++) {
            var e = events[ix];
            if(e['time'] > now) {
                if(ix>0) {
                    evt = events[ix-1];
                }
                next = events[ix];
                break;
            }
        }
        var h = {
            'now': $('#now'),
            'countdown': $('#countdown'),
            'next': $('#next')
        }
        if(!evt) {
            h.now.html('');
            h.countdown.html('--');
            h.next.html('');
        }
        else {
            var special = false;
            for(var ix=0, ex=evt['tags'].length; ix<ex; ix++) {
                if(evt['tags'][ix] == 'special') {
                    special = true;
                    break;
                }
            }

            /*
             * gli special events comprendono pranzi e coffee break;
             * tutti gli altri vengono suddivisi in tre sezioni:
             *  - talk
             *  - sessione di Q&A
             *  - cambio sala
             */

            var elasped = (now - evt['time']) / (60 * 1000 );
            var duration = 0;

            var data = {
                'name': evt['name'],
                'next': {
                    'name': next['name'],
                    'speakers': next['speakers'],
                }
            };

            if(!special) {
                // la durata della sessione di Q&A dipende dalla durata del talk:
                var qa_duration_map = {
                    90: 10
                }
                var durations = {
                    'qa': qa_duration_map[evt['duration']] || 5,
                    'change_room': 5,
                }
                durations['talk'] = evt['duration'] - durations['qa'] - durations['change_room'];

                if(elasped < durations['talk']) {
                    data['next']['name'] = 'Q&A session (' + durations['qa'] + ' min)';
                    data['next']['speakers'] = null;
                    duration = durations['talk'];
                }
                else if(elasped < durations['talk'] + durations['qa']) {
                    data['name'] = 'Q&A session';
                    data['next']['name'] = 'Change room';
                    data['next']['speakers'] = null;
                    duration = durations['talk'] + durations['qa'];
                }
                else {
                    data['name'] = 'Change room';
                    duration = durations['talk'] + durations['qa'] + durations['change_room'];
                }
            }
            else {
                duration = evt['duration'];
            }

            var countdown = duration - elasped;

            h.now.html(data['name']);
            if(data['next']) {
                var msg = 'Next: ' + data['next']['name'];
                if(data['next']['speakers'])
                    msg += ' by ' + data['next']['speakers'];
                h.next.html(msg);
            }
            else {
                h.next.html('');
            }

            h.countdown.html('-' + countdown + "'");
        }
    }
    setInterval(update, 5 * 1000);
</script>
</html>
