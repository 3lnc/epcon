{% extends "p3/base.html" %}
{% load conference assopy_tags %}

{% block EXTRA_HEAD %}
{% if request.user.is_staff %}
    <script type="text/javascript" src="{{ STATIC_URL }}p5/j/jquery.event.drag-2.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}p5/j/jquery.event.drop-2.0.min.js"></script>
{% endif %}
{% endblock %}

{% block MAIN_CONTENT %}
<nav id="schedule-navigator">
    <h3>Search</h3>
    <form class="search">
        <input name="q" value="" />
    </form>
    {% comment %}
    <h3>Show</h3>
    <form class="show-flags">
        <label><input type="checkbox" name="ita" value="" checked> Italian Track</label>
        <label><input type="checkbox" name="trainings" value="" checked> Trainings</label>
        <label><input type="checkbox" name="partner" value="" checked> Partner Program</label>
        <label><input type="checkbox" name="talklevel" value="" checked> Talk Level</label>
        <label><input type="checkbox" name="myvotes" value="" checked> My votes</label>
    </form>
    {% endcomment %}
    <h3>Jump to</h3>
    <ul>
        {% for schedule in schedules %}
        <li><a href="#{{ schedule.slug }}">{{ schedule.date|date:"l" }}</a></li>
        {% endfor %}
    </ul>
</nav>
<div class="page clearfix">
    {% for schedule in schedules %}
    <div id="{{ schedule.slug }}" class="schedule-wrapper"
        data-schedule-url="{% url conference-schedule conference=schedule.conference slug=schedule.slug %}"
        data-schedule-conference="{{ schedule.conference }}"
        data-schedule-slug="{{ schedule.slug }}">
        <div class="cms">
            <h2>Morning &mdash; {{ schedule.date|date:"l d F Y" }}</h2>
            {% if schedule.description %}
            <p>{{ schedule.description|safe }}</p>
            {% endif %}
        </div>
        {% render_schedule2 schedule "09:00" "13:15" %}
        <div class="cms">
            <h2>Afternoon &mdash; {{ schedule.date|date:"l d F Y" }}</h2>
            {% if schedule.description %}
            <p>{{ schedule.description|safe }}</p>
            {% endif %}
        </div>
        {% render_schedule2 schedule "14:30" "" %}
    </div>
    {% endfor %}
</div>
<script type="text/javascript">
    (function() {
        var nav = $('#schedule-navigator');
        var autocomplete = { 'timeout': null, 'last_search': '' };
        function highlight_search_results(ids) {
            if(!ids.length) {
                $('.event[data-event-id]').removeClass('search-result-ok').removeClass('search-result-ko');
            }
            else {
                $('.event[data-event-id]').not('.event.t-break').not('.event.t-special').each(function() {
                    var e = $(this);
                    if(ids.indexOf(e.attr('data-event-id')) == -1) {
                        e.removeClass('search-result-ok').addClass('search-result-ko');
                    }
                    else {
                        e.removeClass('search-result-ko').addClass('search-result-ok');
                    }
                });
            }
        }

        var _search_results = {
            'data': [],
            'scrollTo': -1
        };
        var _search_results = [];
        var _show_search_result = -1;
        function set_search_results(events_ids) {
            _search_results.data = events_ids;
            _search_results.scrollTo = -1;
            highlight_search_results(events_ids);
            scroll_to_next_result();
        }
        function scroll_to_next_result() {
            var data = _search_results.data;

            if(data.length <= 0)
                return;

            _search_results.scrollTo += 1;
            if(_search_results.scrollTo >= data.length)
                _search_results.scrollTo = 0;

            var e = $('.event[data-event-id=' + data[_search_results.scrollTo] + ']')
            $('html, body').animate({
                scrollTop: e.offset().top
            }, 1000);
        }
        function _searchSchedule() {
            var i = $('.search input', nav);
            var value = $.trim(i.val());
            autocomplete['timeout'] = null;
            if(value == '') {
                set_search_results([]);
                autocomplete['last_search'] = i.val();
            }
            else if(value != autocomplete['last_search']) {
                autocomplete['last_search'] = i.val();
                $.ajax({
                    url: '{% url p3-schedule-search %}?conference={{ conference }}&q=' + i.val(),
                    dataType: 'json',
                    success: function(data, status, jqXHR) {
                        var events_ids = [];
                        for(var ix=0; ix<data.length; ix++) {
                            events_ids.push(data[ix].pk);
                        }
                        set_search_results(events_ids);
                    },
                    complete: function() {
                    }
                });
            }
            else {
                scroll_to_next_result();
            }
        }
        $('.search', nav).submit(function() {
            if(autocomplete['timeout']) {
                clearTimeout(autocomplete['timeout']);
                autocomplete['timeout'] = null;
            }
            _searchSchedule();
            return false;
        });
        $('.search input', nav).keyup(function(e) {
            if(e.keyCode == 13)
                return;
            if(autocomplete['timeout']) {
                clearTimeout(autocomplete['timeout']);
            }
            autocomplete['timeout'] = setTimeout(_searchSchedule, 400);
        });
        function _get() {
            var opts = {}
            var raw = $.cookie('schedule_opts');
            if(raw) {
                $.each(raw.split(','), function(ix, val) {
                    opts[val] = '';
                });
            }
            return opts;
        }
        function _set(opts) {
            var raw = [];
            for(var k in opts) {
                raw.push(k);
            }
            $.cookie('schedule_opts', raw.join(','), { expires: 60 });
        }
        var opts = _get();
        var flags = {
            'ita': function() { return [$('.schedule tr[data-track=track-ita]')]; },
            'trainings': function() {
                return [$('.schedule tr[data-track=training1]'), $('.schedule tr[data-track=training2]')];
            },
            'partner': function() {
            },
            'talklevel': function() { return [$('.schedule .talk-level')]; },
            'myvotes': function() { return [$('.schedule .talk-vote')]; }
        }
        function show_flag(name, v) {
            $.each(flags[name](), function(ix, dom) {
                if(!v)
                    dom.hide();
                else
                    dom.show();
            });
        }
        for(var k in opts) {
            $('.show-flags input[name=' + k + ']', nav).attr('checked', null);
            show_flag(k, false);
        }
        $('.show-flags input', nav).change(function() {
            if($(this).is(':checked')) {
                delete opts[this.name];
                show_flag(this.name, true);
            }
            else {
                opts[this.name] = '';
                show_flag(this.name, false);
            }
            _set(opts);
        });
    })();
</script>
{% if request.user.is_staff %}
<div class="overlay" id="schedule-form-box">
    <form action="" method="post">{% csrf_token %}
        <fieldset>
        {% for f in form %}
        {{ f|field }}
        {% endfor %}
        </fieldset>
        <fieldset class="border">
            <button type="submit" name="save">Save</button>
            <button type="submit" name="delete">Delete</button>
        </fieldset>
    </form>
</div>
<script type="text/javascript">
    (function() {
        function _setForm(url, time, track, evt) {
            var form = $('#schedule-form-box form');
            form.attr('action', url)
            $('input[name=start_time]', form).val(time);
            $('input[name=track]', form).val(track);

            var is_talk = false;
            $('select[name=talk] option').each(function() {
                if(this.value == evt) {
                    is_talk = true;
                }
            });

            if(is_talk) {
                $('select[name=talk]', form).val(evt);
                $('textarea[name=custom]', form).val('');
            }
            else {
                $('select[name=talk]', form).val('');
                $('textarea[name=custom]', form).val(evt);
            }
            return form;
        }
        function initSchedule(target) {
            if(!target)
                target = $(document.body);
            $('.schedule .event .tools', target).append($('<div><a href="#" class="schedule-edit"><img src="{{ STATIC_URL }}p5/i/edit-icon.png" /></a></div>'));
            $('.schedule .schedule-edit', target).click(function(e) {
                e.preventDefault();
                var cell = $(e.target).parents('.event');
                var event_url = cell.attr('data-event-url');
                var schedule = cell.parents('.schedule-wrapper');
                var track = cell.attr('data-track');
                var time = cell.attr('data-time');
                var evt = $('h3', cell).attr('data-talk');
                if(!evt)
                    evt = $('div.custom-event', cell).text();
                editEvent(schedule, event_url, track, time, evt, true);
            });
            $('.schedule thead .hhmm', target).click(function(e) {
                var cell = $(e.currentTarget);
                var time = cell.text(); 
                var schedule = cell.parents('.schedule-wrapper');
                editEvent(schedule, schedule.attr('data-schedule-url'), '', time, '', false);
            });
            $('td.event[data-event-url]', target)
                .drag("start",function(){
                    return $('<div style="position: absolute; background: red">TALK</div>')
                        .css("opacity", .75 )
                        .appendTo(document.body);
                })
                .drag(function( ev, dd ){
                    $( dd.proxy).css({
                        top: dd.offsetY,
                        left: dd.offsetX
                    });
                })
                .drag("end",function( ev, dd ){
                    $( dd.proxy ).remove();
                });
            $('td.event', target)
                .not('td.event[data-event-url]')
                .drop(function(e, dd){
                    var drop = $(this);
                    var dropTime = drop.attr('data-time');
                    var dropTrack = drop.parents('tr').attr('data-track');
                    var dropSchedule = drop.parents('.schedule-wrapper');
                    var drag = $(dd.drag);
                    moveEvent(drag, dropSchedule, dropTime, dropTrack);
                });
        }
        function moveEvent(evt, schedule, time, track) {
            $.ajax({
                url: evt.attr('data-event-url'),
                type: 'POST',
                data: {
                    schedule_conference: schedule.attr('data-schedule-conference'),
                    schedule_slug: schedule.attr('data-schedule-slug'),
                    start_time: time,
                    track: track
                },
                success: function() {
                    var old_schedule = evt.parents('.schedule-wrapper');
                    refreshSchedule(schedule);
                    if(old_schedule.attr('data-schedule-url') != schedule.attr('data-schedule-url')) {
                        refreshSchedule(old_schedule);
                    }
                }
            });
        }
        function refreshSchedule(schedule) {
            $.ajax({
                url: schedule.attr('data-schedule-url'),
                success: function(data) {
                    schedule.html(data);
                    initSchedule(schedule);
                }
            });
        }
        $('#schedule-form-box button[name=delete]').click(function(e) {
            var form = $(this).parents('form');
            form.attr('method', 'DELETE');
        });
        $('#schedule-form-box button[name=save]').click(function(e) {
            var form = $(this).parents('form');
            form.attr('method', 'POST');
        });
        function editEvent(schedule, event_url, track, time, evt, exists) {
            var url = event_url || schedule.attr('data-schedule-url');
            var editor = $('#schedule-form-box');
            if(exists)
                $('button[name=delete]', editor).show();
            else
                $('button[name=delete]', editor).hide();
            var form = _setForm(url, time, track, evt);
            form.one('submit', function() {
                form.ajaxSubmit({
                    success: function(data, status, jqXHR) {
                        editor.overlay().close();
                        refreshSchedule(schedule);
                    }
                });
                return false;
            });
            editor.overlay({ load: true });
            /*
             * jQueryTools sta vincendo il premio come software più bacato: le
             * due righe che seguono servono a mostrare l'overlay dopo la prima
             * volta.
             * http://flowplayer.org/tools/forum/40/40917
             */
            editor.data("overlay").load();
            editor.css('style', 'block');
        };
        initSchedule();
    })();
</script>
{% endif %}
{% endblock %}

{% block SPONSORS %}
<!-- Omit sponsors col -->
{% endblock %}
