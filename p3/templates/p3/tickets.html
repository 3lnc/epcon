{% extends "assopy/base.html" %}
{% load p3 %}
{% block MAIN_CONTENT %}
    
    <h1>Your tickets</h1>
    
    {% if not tickets %}
    <section class="notice">
        <p>You still have not bought any ticket with this account. Please proceed to the <a href="{% url p3-cart %}">cart</a> to place an order.</p>
    </section>
    {% endif %}

    {% for t in tickets %}
        <div class="span-6 {% cycle '' 'last' %}">
            {% render_ticket t %}
        </div>
        {% cycle '' '<hr />' %}    
    {% endfor %}
    <script type="text/javascript">//<![CDATA[
    $('div.ticket form').live('submit', function(e) {
        /*
         * non mi piace impedire il submit da tasto invio, ma devo essere
         * sicuro che venga eseguito il codice collegato con i
         * button[type=submit]. Nota che con FF e chrome ( e forse con altri
         * browser) questo non è un problema, perché la pressione dell'invio in
         * un input causa l'evento click nel input/button di tipo submit
         */

        e.preventDefault();
    });
    $('div.ticket form button[type=submit]').live('click', function(e) {
        e.preventDefault();
        var form = $(e.target).parents('form');
        var container = form.parents('div.ticket');
        form.ajaxSubmit({
            target: container,
            replaceTarget: true,
            success: function() {
                feedback('Ticket saved');
            },
            beforeSubmit: function(arr, form, options) {
                /*
                 * L'unico campo che assolutamente voglio è il nome del
                 * partecipante.
                 */
                var ticket = form.parents('.ticket');
                if(ticket.hasClass('conference'))
                    var f = ticket_field(form, 'ticket_name');
                else
                    var f = ticket_field(form, 'name');
                var n = f.val().trim();
                if(n == '') {
                    alert('Please enter the name');
                    f.focus();
                    return false;
                }
                return true;
            },
            error: function(xhr, status, error) {
                alert('Cannot save the ticket.\nUse the web chat, or contact info@pycon.it, for assistance.');
            }
        });
    });
    function ticket_field(form, field_name) {
        var tid = $(form).parents('div.ticket').attr('data-ticket');
        return $('input[name=t' + tid + '-' + field_name + ']', form);
    }
    $('div.ticket .assign-button').live('click', function(e) {
        e.preventDefault();
        var email = prompt('Enter the email of the person you want to assign the ticket').trim();
        if(!email)
            return;
        if(email == "{{ request.user.email }}") {
            alert('Please don\'t use your email address.');
            return;
        }
        var ticket = $(e.target).parents('.ticket');
        var form = $('form', ticket);
        ticket_field(form, 'assigned_to').val(email);
        form.ajaxSubmit(function() {
            feedback('ticket assigned to ' + email);
            $('.ticket-assigned-to', ticket).show().children('b').html(email);
            $('.ticket-commands', ticket).hide();
        });
    });
    $('div.ticket .reclaim-button').live('click', function(e) {
        e.preventDefault();
        if(window.confirm('Are you sure to reclaim this ticket')) {
            var ticket = $(e.target).parents('.ticket');
            var form = $('form', ticket);
            ticket_field(form, 'assigned_to').val('');
            form.ajaxSubmit(function() {
                feedback('ticket reclaimed');
                $('.ticket-assigned-to', ticket).hide().children('b').html('');
                $('.ticket-commands', ticket).show();
            });
        }
    });
    //]]>
    </script>
{% endblock %}
