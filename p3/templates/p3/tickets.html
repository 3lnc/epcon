{% extends "assopy/base.html" %}
{% load p3 %}
{% block MAIN_CONTENT %}
    
    <h1>Your tickets</h1>

    {% for t in tickets %}
        <div class="span-6 {% cycle '' 'last' %}">
            {% render_ticket t %}
        </div>
        
        {% cycle '' '<hr />' %}    
    {% endfor %}
    <script type="text/javascript">//<![CDATA[
    $('div.ticket form button[type=submit]').click(function(e) {
        e.preventDefault();
        var form = $(e.target).parents('form');
        form.ajaxSubmit({
            success: function() {
                feedback('Ticket saved');
            },
            beforeSubmit: function(arr, form, options) {
                /*
                 * L'unico campo che assolutamente voglio Ã¨ il nome del
                 * partecipante.
                 */
                var ticket = form.parents('.ticket');
                if(ticket.hasClass('conference'))
                    var f = ticket_field(form, 'ticket_name');
                else
                    var f = ticket_field(form, 'name');
                var n = f.val().trim();
                if(n == '') {
                    alert('Please enter the name');
                    f.focus();
                    return false;
                }
                return true;
            },
            error: function(xhr, status, error) {
                alert('Cannot save the ticket.\nUse the web chat, or contact info@pycon.it, for assistance.');
            }
        });
    });
    function ticket_field(form, field_name) {
        var tid = $(form).attr('data-ticket');
        return $('input[name=t' + tid + '-' + field_name + ']', form);
    }
    $('div.ticket .assign-button').click(function(e) {
        e.preventDefault();
        var email = prompt('Enter the email of the person you want to assign the ticket').trim();
        if(!email)
            return;
        if(email == "{{ request.user.email }}") {
            alert('Please don\'t use your email address.');
            return;
        }
        var ticket = $(e.target).parents('.ticket');
        var form = $('form', ticket);
        ticket_field(form, 'assigned_to').val(email);
        console.log(email, form);
        form.ajaxSubmit(function() {
            feedback('ticket assigned to ' + email);
            $('.ticket-assigned-to', ticket).show().children('b').html(email);
            $('.ticket-commands', ticket).hide();
        });
    });
    $('div.ticket .reclaim-button').live('click', function(e) {
        e.preventDefault();
        if(window.confirm('Are you sure to reclaim this ticket')) {
            var ticket = $(e.target).parents('.ticket');
            var form = $('form', ticket);
            ticket_field(form, 'assigned_to').val('');
            form.ajaxSubmit(function() {
                feedback('ticket reclaimed');
                $('.ticket-assigned-to', ticket).hide().children('b').html('');
                $('.ticket-commands', ticket).show();
            });
        }
    });
    //]]>
    </script>
{% endblock %}
