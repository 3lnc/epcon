{% extends "p3/base.html" %}
{% load i18n conference assopy_tags hcomments_tags %}

{% block PAGE_TITLE %}{{ talk.title }} &mdash; {% endblock %}

{% block EXTRA_HEAD %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}conference/projekktor/projekktor.js"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}conference/projekktor/style/projekktor_theme_tll/style.css" type="text/css" media="screen" />
<script type="text/javascript">
var PROJEKKTOR_CONFIG = {
    playerFlashMP4:    "{{ STATIC_URL }}conference/projekktor/playerMP4.swf",
    playerFlashMP3:    "{{ STATIC_URL }}conference/projekktor/playerMP3.swf"
};
</script>
<script type="text/javascript">//<![CDATA[
    $(function() {
        hcomments.comments({
            'form': $('#add-comment form.new-comment'),
            'wrapper': $('#comments'),
            'comments': $('#comments li'),
            'remove': "{% url hcomments-delete-comment %}"
        });
        hcomments.onCommentModerated = function(comment) {
            var e = comment ? comment : $('.form-box');
            var msg = $('<div class="comment-moderated">{% trans "Lo staff sta controllando il tuo commento, a breve verr√† pubblicato." %}</div>');
            e.prepend(msg)
            setTimeout(function() {
                $('.comment-moderated', e).remove();
            }, 10000);
            $('.form-box form').get(0).reset();
        }
    });
//]]>
    </script>
{% endblock %}

{% block MAIN_CONTENT %}
    <h1>{{ talk.title }}
    {% if full_access %}
    <span class="action edit"><a href="#">(Edit talk)</a></span>
    <script type="text/javascript">//<![CDATA[
    $('.action a').click(function(e) {
        e.preventDefault();
        $('div.readonly').hide();
        $('div.writable').show();
        $(e.target).hide();
    });
    //]]>
    </script>
    {% endif %}</h1>
    <div class="span-8">
        <div class="page-summary">
            <p>
                {% trans "di" %}
                {% for spk in talk.get_all_speakers %}
                <a href="{{ spk.get_absolute_url }}">{{ spk.name }}</a>
                {% if not forloop.last %}-{% endif %}
                {% endfor %}
            </p>
        </div>
        {% with talk.get_event as e %}
        {% with e.get_track as track %}
        <div class="readonly"{% if form.errors|length > 0 %} style="display: none;"{% endif %}>
            <div class="cms">
                {% conference_multilingual_attribute talk "abstracts" as ab fallback "any" %}
                <p>{{ ab.body|linebreaks }}</p>
            </div>
            {% if talk.status == "accepted" %}
            <section class="talk when">
                {% if e.schedule.conference == CONFERENCE %}{% trans "in" %} <i>{{ e.get_track.title|safe }}</i>{% endif %}
                <a href="{% url p3-schedule conference=e.schedule.conference %}"><b>See schedule</b></a>
            </section>
            {% if talk|embed_video %}
            <section class="talk video">
                <h2>{% trans "Video" %}</h2>
                {{ talk|embed_video:"720,576" }}
            </section>
            {% endif %}
            {% endif %}
        </div>
        {% endwith %}
        {% endwith %}
        {% if full_access %}
        <div class="writable"{% if form.errors|length == 0 %} style="display: none;"{% endif %}>
            <form class="talk-details" action="{% url conference-talk slug=talk.slug %}" method="post" enctype="multipart/form-data">{% csrf_token %}
                <fieldset>
                {{ form.title|field }}
                {% if cfp %}
                {{ form.training|field }}
                {{ form.duration|field }}
                {{ form.language|field }}
                {{ form.level|field }}
                {% endif %}
                {{ form.slides|field }}
                {{ form.abstract|field }}
                </fieldset>
                <fieldset class="border">
                    <button name="" value="" type="submit">Save Changes</button>
                </fieldset>
            </form>
        </div>
        {% endif %}
        {% get_comment_list talk as comments %}
        {% if comments %}
            <h3>Comments</h3>
            {% show_comment_list talk talk.get_all_speakers.0.user %}
        {% else %}
            <h3>Do you have some questions on this talk? Leave a comment to the speaker!</h3>
        {% endif %}
        {% show_comment_form talk %}
    </div>
    <div class="span-4 last">
        <div class="talk details">
            {% if talk.slides %}
            <div class="button mini">
                {% stuff_info talk.slides as info %}
                <a href="{{ talk.slides.url }}">Download slide ({{ info.0 }})</a><br />
                (Size: {{ info.1|filesizeformat }})
            </div>
            <hr />
            {% endif %}
            <dl>
                <dt>{% trans "Lingua" %}</dt>
                <dd>{{ talk.language|upper }}</dd>

                <dt>{% trans "Durata" %}</dt>
                <dd>{{ talk.duration }} {% trans "minuti" %}</dd>

                {% if track.translate %}
                <dt>{% trans "Traduzione simultanea" %}</dt>
                <dd>{% trans "disponibile" %}</dd>
                {% endif %}
            </dl>
            {% if voting %}
            <div id="talk-voting">
                <form action="{% url conference-voting %}" method="post">{% csrf_token %}
                    Vote this talk:
                    {% talk_vote talk as vote %}
                    <input name="vote-{{ talk.id }}" id="id_vote-{{ talk.id }}" type="range" min="0" max="10" value="{{ vote.vote|default:"0" }}" step="0.5" />
                    <div class="rateit" data-rateit-backingfld="#id_vote-{{ talk.id }}"></div>
                    <div>
                        <a href="{% url conference-voting %}">Back to the voting list</a>
                    </div>
                </form>
                <script type="text/javascript">
                    function rate(e, val) {
                        var field = $(e.rateit('backingfld'));
                        var form = field.parents('form');
                        if(val == undefined) 
                            field.val(e.rateit('value'))
                        else
                            field.val(val);
                        form.ajaxSubmit();
                    }
                    $('#talk-voting .rateit')
                        .rateit()
                        .bind('rated', function() {
                            rate($(this));
                        })
                        .bind('reset', function() {
                            rate($(this), 0);
                        });
                </script>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}


